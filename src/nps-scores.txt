import React, { useState } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';

export default function NPSDashboard() {
  const allData = [
    {
      season: "Season 13",
      season_phase: "Summer",
      program: "Pro",
      coach: "Anand Dasgupta",
      runner_status: "New",
      feedback_nps: 75,
      comms_nps: 75,
      rel_nps: 75,
      reco_nps: 75,
      rhwb_comms_nps: 50,
      rhwb_knowledge_nps: 75,
      rhwb_reco_nps: 75,
      total_responses: 4
    },
    {
      season: "Season 13",
      season_phase: "Summer",
      program: "Pro",
      coach: "Anand Dasgupta",
      runner_status: "Return",
      feedback_nps: 100,
      comms_nps: 100,
      rel_nps: 75,
      reco_nps: 100,
      rhwb_comms_nps: 75,
      rhwb_knowledge_nps: 50,
      rhwb_reco_nps: 100,
      total_responses: 4
    },
    {
      season: "Season 13",
      season_phase: "Summer",
      program: "Pro",
      coach: "Ajaykumar Jadhav",
      runner_status: "New",
      feedback_nps: 80,
      comms_nps: 80,
      rel_nps: 80,
      reco_nps: 80,
      rhwb_comms_nps: 100,
      rhwb_knowledge_nps: 100,
      rhwb_reco_nps: 100,
      total_responses: 5
    },
    {
      season: "Season 13",
      season_phase: "Summer",
      program: "Pro",
      coach: "Ajaykumar Jadhav",
      runner_status: "Return",
      feedback_nps: 87,
      comms_nps: 95.7,
      rel_nps: 95.7,
      reco_nps: 100,
      rhwb_comms_nps: 95.7,
      rhwb_knowledge_nps: 100,
      rhwb_reco_nps: 100,
      total_responses: 23
    }
  ];

  const seasons = [...new Set(allData.map(d => d.season))];
  const coaches = [...new Set(allData.map(d => d.coach))];
  const programs = ['Pro', 'Masters', 'Walk'];
  
  const [selectedSeason, setSelectedSeason] = useState(seasons[0]);
  const [selectedCoach, setSelectedCoach] = useState(coaches[0]);

  // Calculate overall averages across all coaches for the selected season and program
  const calculateOverallAverages = (program) => {
    const programData = allData.filter(d => 
      d.season === selectedSeason && 
      d.program === program
    );
    
    if (programData.length === 0) return null;
    
    return {
      feedback: Math.round(programData.reduce((sum, item) => sum + item.feedback_nps, 0) / programData.length),
      comms: Math.round(programData.reduce((sum, item) => sum + item.comms_nps, 0) / programData.length),
      rel: Math.round(programData.reduce((sum, item) => sum + item.rel_nps, 0) / programData.length),
      reco: Math.round(programData.reduce((sum, item) => sum + item.reco_nps, 0) / programData.length),
      rhwb_comms: Math.round(programData.reduce((sum, item) => sum + item.rhwb_comms_nps, 0) / programData.length),
      rhwb_knowledge: Math.round(programData.reduce((sum, item) => sum + item.rhwb_knowledge_nps, 0) / programData.length),
      rhwb_reco: Math.round(programData.reduce((sum, item) => sum + item.rhwb_reco_nps, 0) / programData.length)
    };
  };

  const ProgramCard = ({ program }) => {
    const programData = allData.filter(d => 
      d.coach === selectedCoach && 
      d.season === selectedSeason && 
      d.program === program
    );

    const overallAvg = calculateOverallAverages(program);

    if (programData.length === 0) {
      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <h3 className="text-xl font-bold text-gray-800 mb-4">{program}</h3>
          <div className="flex items-center justify-center h-40 text-gray-400">
            No data available
          </div>
        </div>
      );
    }

    const totalResponses = programData.reduce((sum, item) => sum + item.total_responses, 0);
    
    // Get individual runner data
    const newRunner = programData.find(d => d.runner_status === 'New');
    const returnRunner = programData.find(d => d.runner_status === 'Return');
    
    // Coach Performance Metrics
    const avgFeedback = Math.round(programData.reduce((sum, item) => sum + item.feedback_nps, 0) / programData.length);
    const avgCoachComms = Math.round(programData.reduce((sum, item) => sum + item.comms_nps, 0) / programData.length);
    const avgCoachRel = Math.round(programData.reduce((sum, item) => sum + item.rel_nps, 0) / programData.length);
    const avgCoachReco = Math.round(programData.reduce((sum, item) => sum + item.reco_nps, 0) / programData.length);
    
    // RHWB Club Performance Metrics
    const avgRhwbComms = Math.round(programData.reduce((sum, item) => sum + item.rhwb_comms_nps, 0) / programData.length);
    const avgRhwbKnowledge = Math.round(programData.reduce((sum, item) => sum + item.rhwb_knowledge_nps, 0) / programData.length);
    const avgRhwbReco = Math.round(programData.reduce((sum, item) => sum + item.rhwb_reco_nps, 0) / programData.length);

    const getScoreColor = (score) => {
      if (score > 90) return 'text-green-800';
      if (score >= 50 && score <= 90) return 'text-green-700';
      if (score >= 0 && score < 50) return 'text-orange-800';
      if (score >= -50 && score < 0) return 'text-red-300';
      return 'text-red-800';
    };

    const getBgColor = (score) => {
      if (score > 90) return 'bg-green-700';
      if (score >= 50 && score <= 90) return 'bg-green-200';
      if (score >= 0 && score < 50) return 'bg-orange-200';
      if (score >= -50 && score < 0) return 'bg-red-200';
      return 'bg-red-600';
    };

    const getCardBgColor = (score) => {
      if (score > 90) return 'bg-green-700';
      if (score >= 50 && score <= 90) return 'bg-green-100';
      if (score >= 0 && score < 50) return 'bg-orange-100';
      if (score >= -50 && score < 0) return 'bg-red-100';
      return 'bg-red-600';
    };

    const MetricCard = ({ label, newScore, returnScore, borderColor, avgScore }) => {
      const avg = Math.round((newScore + returnScore) / 2);
      const diff = avgScore ? avg - avgScore : 0;
      const isAboveAvg = diff > 0;
      
      return (
        <div className={`p-3 ${getCardBgColor(avg)} rounded-lg border-l-4 ${borderColor}`}>
          <div className="flex items-center justify-between mb-2">
            <div className="flex-1">
              <div className="text-xs text-gray-700 mb-1 font-medium">{label}</div>
              <div className={`text-3xl font-bold ${getScoreColor(avg)}`}>{avg}</div>
            </div>
            <div className="flex flex-col gap-1 text-xs ml-3">
              <div className="flex items-center gap-1">
                <span className="text-gray-700">New:</span>
                <span className={`font-semibold ${getScoreColor(newScore)}`}>{newScore}</span>
              </div>
              <div className="flex items-center gap-1">
                <span className="text-gray-700">Return:</span>
                <span className={`font-semibold ${getScoreColor(returnScore)}`}>{returnScore}</span>
              </div>
            </div>
          </div>
          
          {avgScore !== null && (
            <div className="mt-2 pt-2 border-t border-gray-300">
              <div className="flex items-center justify-between text-xs mb-1">
                <span className="text-gray-600">vs Average:</span>
                <span className={`font-semibold ${isAboveAvg ? 'text-green-700' : 'text-red-700'}`}>
                  {isAboveAvg ? '+' : ''}{diff}
                </span>
              </div>
              <div className="relative w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className={`absolute h-full ${isAboveAvg ? 'bg-green-500' : 'bg-red-500'} transition-all`}
                  style={{ 
                    width: `${Math.min(Math.abs(diff) * 2, 100)}%`,
                    left: isAboveAvg ? '50%' : `${50 - Math.min(Math.abs(diff) * 2, 50)}%`
                  }}
                />
                <div className="absolute left-1/2 top-0 w-0.5 h-full bg-gray-400" />
              </div>
            </div>
          )}
        </div>
      );
    };

    return (
      <div className="bg-white rounded-lg shadow-md p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold text-gray-800">{program}</h3>
          <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
            {totalResponses} responses
          </span>
        </div>

        {/* Coach Performance */}
        <div className="mb-6">
          <h4 className="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wide">Coach Performance</h4>
          <div className="grid grid-cols-2 gap-3">
            <MetricCard 
              label="Feedback" 
              newScore={newRunner?.feedback_nps || 0}
              returnScore={returnRunner?.feedback_nps || 0}
              borderColor="border-blue-500"
              avgScore={overallAvg?.feedback}
            />
            <MetricCard 
              label="Communications" 
              newScore={Math.round(newRunner?.comms_nps || 0)}
              returnScore={Math.round(returnRunner?.comms_nps || 0)}
              borderColor="border-blue-500"
              avgScore={overallAvg?.comms}
            />
            <MetricCard 
              label="Relationship" 
              newScore={Math.round(newRunner?.rel_nps || 0)}
              returnScore={Math.round(returnRunner?.rel_nps || 0)}
              borderColor="border-blue-500"
              avgScore={overallAvg?.rel}
            />
            <MetricCard 
              label="Recommendation" 
              newScore={newRunner?.reco_nps || 0}
              returnScore={returnRunner?.reco_nps || 0}
              borderColor="border-blue-500"
              avgScore={overallAvg?.reco}
            />
          </div>
        </div>

        {/* RHWB Club Performance */}
        <div className="mb-4">
          <h4 className="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wide">RHWB Club Performance</h4>
          <div className="grid grid-cols-3 gap-3">
            <MetricCard 
              label="Communications" 
              newScore={Math.round(newRunner?.rhwb_comms_nps || 0)}
              returnScore={Math.round(returnRunner?.rhwb_comms_nps || 0)}
              borderColor="border-purple-500"
              avgScore={overallAvg?.rhwb_comms}
            />
            <MetricCard 
              label="Knowledge" 
              newScore={newRunner?.rhwb_knowledge_nps || 0}
              returnScore={returnRunner?.rhwb_knowledge_nps || 0}
              borderColor="border-purple-500"
              avgScore={overallAvg?.rhwb_knowledge}
            />
            <MetricCard 
              label="Recommendation" 
              newScore={newRunner?.rhwb_reco_nps || 0}
              returnScore={returnRunner?.rhwb_reco_nps || 0}
              borderColor="border-purple-500"
              avgScore={overallAvg?.rhwb_reco}
            />
          </div>
        </div>
      </div>
    );
  };

  const data = allData.filter(d => d.coach === selectedCoach && d.season === selectedSeason);
  const seasonPhase = data.length > 0 ? data[0].season_phase : '';

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header Section with Filters */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-4">NPS Performance Dashboard</h1>
          
          <div className="grid md:grid-cols-2 gap-4">
            <div className="flex items-center gap-3">
              <label htmlFor="season-select" className="text-gray-700 font-semibold whitespace-nowrap">
                Season:
              </label>
              <select
                id="season-select"
                value={selectedSeason}
                onChange={(e) => setSelectedSeason(e.target.value)}
                className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 bg-white hover:border-blue-500 focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all cursor-pointer"
              >
                {seasons.map(season => (
                  <option key={season} value={season}>
                    {season}
                  </option>
                ))}
              </select>
            </div>

            <div className="flex items-center gap-3">
              <label htmlFor="coach-select" className="text-gray-700 font-semibold whitespace-nowrap">
                Coach:
              </label>
              <select
                id="coach-select"
                value={selectedCoach}
                onChange={(e) => setSelectedCoach(e.target.value)}
                className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 bg-white hover:border-blue-500 focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all cursor-pointer"
              >
                {coaches.map(coach => (
                  <option key={coach} value={coach}>
                    {coach}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </div>

        {/* Programs Side by Side */}
        <div className="mb-6">
          <div className="grid md:grid-cols-3 gap-6">
            {programs.map(program => (
              <ProgramCard key={program} program={program} />
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}